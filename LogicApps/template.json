{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "workflows_InvoiceProcessing_name": {
            "defaultValue": "InvoiceProcessing",
            "type": "String"
        },
        "connections_office365_externalid": {
            "defaultValue": "/subscriptions/7620f9be-bf91-4297-ada2-659d2695b3a1/resourceGroups/rg-ne-alice-dev/providers/Microsoft.Web/connections/office365",
            "type": "String"
        },
        "customApis_powerpulse_externalid": {
            "defaultValue": "/subscriptions/7620f9be-bf91-4297-ada2-659d2695b3a1/resourceGroups/rg-ne-alice-dev/providers/Microsoft.Web/customApis/powerpulse",
            "type": "String"
        },
        "connections_powerpulse_externalid": {
            "defaultValue": "/subscriptions/7620f9be-bf91-4297-ada2-659d2695b3a1/resourceGroups/rg-ne-alice-dev/providers/Microsoft.Web/connections/powerpulse",
            "type": "String"
        },
        "connections_commondataservice_externalid": {
            "defaultValue": "/subscriptions/7620f9be-bf91-4297-ada2-659d2695b3a1/resourceGroups/rg-ne-alice-dev/providers/Microsoft.Web/connections/commondataservice",
            "type": "String"
        },
        "connections_formrecognizer_externalid": {
            "defaultValue": "/subscriptions/7620f9be-bf91-4297-ada2-659d2695b3a1/resourceGroups/rg-ne-alice-dev/providers/Microsoft.Web/connections/formrecognizer",
            "type": "String"
        },
        "connections_encodiandocumentmanager_externalid": {
            "defaultValue": "/subscriptions/7620f9be-bf91-4297-ada2-659d2695b3a1/resourceGroups/rg-ne-alice-dev/providers/Microsoft.Web/connections/encodiandocumentmanager",
            "type": "String"
        },
        "connections_sharepointonline_externalid": {
            "defaultValue": "/subscriptions/7620f9be-bf91-4297-ada2-659d2695b3a1/resourceGroups/rg-ne-alice-dev/providers/Microsoft.Web/connections/sharepointonline",
            "type": "String"
        },
        "customApis_lnbits_externalid": {
            "defaultValue": "/subscriptions/7620f9be-bf91-4297-ada2-659d2695b3a1/resourceGroups/rg-lnbits-ne/providers/Microsoft.Web/customApis/lnbits",
            "type": "String"
        },
        "connections_lnbits_externalid": {
            "defaultValue": "/subscriptions/7620f9be-bf91-4297-ada2-659d2695b3a1/resourceGroups/rg-ne-alice-dev/providers/Microsoft.Web/connections/lnbits",
            "type": "String"
        }
    },
    "variables": {},
    "resources": [
        {
            "type": "Microsoft.Logic/workflows",
            "apiVersion": "2017-07-01",
            "name": "[parameters('workflows_InvoiceProcessing_name')]",
            "location": "northeurope",
            "properties": {
                "state": "Enabled",
                "definition": {
                    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "Account Email Address": {
                            "defaultValue": "accounts@evolabs.ie",
                            "type": "String"
                        },
                        "Alice Document Intelligence Model Name": {
                            "defaultValue": "AliceV3",
                            "type": "String"
                        },
                        "Alice Mailbox ID": {
                            "defaultValue": "13811160-c2b2-4158-9041-0892776bed36",
                            "type": "String"
                        },
                        "Dataverse URL": {
                            "defaultValue": "https://alicedev.crm4.dynamics.com",
                            "type": "String"
                        },
                        "Function URL": {
                            "defaultValue": "https://alice-dev-functions.azurewebsites.net/api/Invoice_Notification?code=QCErdpfjwkxMpWJ9Px_trQQ5zgHJ3Hh8i3uFphBUbHBuAzFui8A4ug%3D%3D",
                            "type": "String"
                        },
                        "MS Teams Channel ID": {
                            "defaultValue": "19:hrOjgOR_jx2lvU2BNwIUU55RsBL7JBZOuqnn05Y76qw1@thread.tacv2",
                            "type": "String"
                        },
                        "Monder Driven App ID": {
                            "defaultValue": "3a9bc01e-f386-ef11-ac20-000d3a679024",
                            "type": "String"
                        },
                        "Alice LNBits UserID": {
                            "defaultValue": "bdbe41518122490ab01d6802f4eaf1b9",
                            "type": "String"
                        },
                        "LnBits Funding User ID": {
                            "defaultValue": "07b55a831eea478585ad3c9426fac239",
                            "type": "String"
                        },
                        "LNBitsURL": {
                            "defaultValue": "https://finickyoil0.lnbits.com",
                            "type": "String"
                        },
                        "LNBits Admin Key": {
                            "defaultValue": "1d5658a73ecf426d9039b6c5f30a3de5",
                            "type": "SecureString"
                        },
                        "$connections": {
                            "defaultValue": {},
                            "type": "Object"
                        }
                    },
                    "triggers": {
                        "When_a_new_email_arrives_in_a_shared_mailbox_(V2)": {
                            "recurrence": {
                                "frequency": "Minute",
                                "interval": 3
                            },
                            "evaluatedRecurrence": {
                                "frequency": "Minute",
                                "interval": 3
                            },
                            "splitOn": "@triggerBody()?['value']",
                            "type": "ApiConnection",
                            "inputs": {
                                "host": {
                                    "connection": {
                                        "name": "@parameters('$connections')['office365']['connectionId']"
                                    }
                                },
                                "method": "get",
                                "path": "/v2/SharedMailbox/Mail/OnNewEmail",
                                "queries": {
                                    "mailboxAddress": "@parameters('Account Email Address')",
                                    "importance": "Any",
                                    "hasAttachments": true,
                                    "includeAttachments": true,
                                    "folderId": "Inbox"
                                }
                            }
                        }
                    },
                    "actions": {
                        "Adaptive_Card": {
                            "runAfter": {},
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "Adaptive Card",
                                        "type": "object"
                                    }
                                ]
                            }
                        },
                        "Check_if_the_status_is_Processed_or_Rejected": {
                            "actions": {
                                "Create_application_measurements": {
                                    "type": "ApiConnection",
                                    "inputs": {
                                        "host": {
                                            "connection": {
                                                "name": "@parameters('$connections')['powerpulse']['connectionId']"
                                            }
                                        },
                                        "method": "post",
                                        "body": {
                                            "appName": "Alice for account",
                                            "flowName": "[parameters('workflows_InvoiceProcessing_name')]",
                                            "isProduction": false,
                                            "measurements": [
                                                {
                                                    "measureName": "null",
                                                    "type": "Time",
                                                    "unit": "Minute",
                                                    "value": "20"
                                                },
                                                {
                                                    "measureName": "null",
                                                    "type": "Money",
                                                    "unit": "Euro",
                                                    "value": "30"
                                                }
                                            ]
                                        },
                                        "headers": {
                                            "Content-Type": "application/json"
                                        },
                                        "path": "/CreateApplicationMeasurement"
                                    }
                                }
                            },
                            "runAfter": {
                                "Switch": [
                                    "Succeeded"
                                ]
                            },
                            "else": {
                                "actions": {}
                            },
                            "expression": {
                                "or": [
                                    {
                                        "equals": [
                                            "@variables('vStatusName')",
                                            683430002
                                        ]
                                    },
                                    {
                                        "equals": [
                                            "@variables('vStatusName')",
                                            683430003
                                        ]
                                    }
                                ]
                            },
                            "type": "If"
                        },
                        "Company_Address": {
                            "runAfter": {
                                "Company_Name_Confidence": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "vCompanyAddress",
                                        "type": "string"
                                    }
                                ]
                            }
                        },
                        "Company_Address_Confidence": {
                            "runAfter": {
                                "Company_Address": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "vCompanyAddressConfidence",
                                        "type": "float"
                                    }
                                ]
                            }
                        },
                        "Company_Name": {
                            "runAfter": {
                                "Converted_Invoice_Date": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "vCompanyName",
                                        "type": "string"
                                    }
                                ]
                            }
                        },
                        "Company_Name_Confidence": {
                            "runAfter": {
                                "Company_Name": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "vCompanyNameConfidence",
                                        "type": "float"
                                    }
                                ]
                            }
                        },
                        "Compose": {
                            "runAfter": {
                                "Number_of_Processed_Invoices": [
                                    "Succeeded"
                                ]
                            },
                            "type": "Compose",
                            "inputs": "@parameters('Alice Document Intelligence Model Name')"
                        },
                        "Compose_1": {
                            "runAfter": {
                                "Adaptive_Card": [
                                    "Succeeded"
                                ]
                            },
                            "type": "Compose",
                            "inputs": "@workflow()"
                        },
                        "Confidence_Max": {
                            "runAfter": {
                                "Confidence_Min": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "vConfidenceMax",
                                        "type": "float"
                                    }
                                ]
                            }
                        },
                        "Confidence_Min": {
                            "runAfter": {
                                "NextStep": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "vConfidenceMin",
                                        "type": "float"
                                    }
                                ]
                            }
                        },
                        "Converted_Invoice_Date": {
                            "runAfter": {
                                "Confidence_Max": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "vConvertedInvoiceDate",
                                        "type": "string"
                                    }
                                ]
                            }
                        },
                        "Currency_Symbols_Array": {
                            "runAfter": {
                                "Compose": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "CurrencySymbolsArray",
                                        "type": "array",
                                        "value": [
                                            "$",
                                            "€",
                                            "£",
                                            "¥",
                                            "₹",
                                            "₩",
                                            "₽",
                                            "₺",
                                            "₪",
                                            "₫",
                                            "₴",
                                            "₦",
                                            "฿",
                                            "R$",
                                            "₵",
                                            "₡",
                                            "د.ك",
                                            "د.إ",
                                            "R"
                                        ]
                                    }
                                ]
                            }
                        },
                        "Document_Type": {
                            "runAfter": {
                                "Total_Shipping_Confidence": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "vDocumentType",
                                        "type": "string"
                                    }
                                ]
                            }
                        },
                        "Document_Type_Confidence": {
                            "runAfter": {
                                "Document_Type": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "vDocumentTypeConfidence",
                                        "type": "float"
                                    }
                                ]
                            }
                        },
                        "FloatInvoiceSubTotal": {
                            "runAfter": {
                                "Invoice_SubTotal": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "FloatInvoiceSubTotal",
                                        "type": "float"
                                    }
                                ]
                            }
                        },
                        "FloatInvoiceTotal": {
                            "runAfter": {
                                "Invoice_Date_Confidence": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "FloatInvoiceTotal",
                                        "type": "float"
                                    }
                                ]
                            }
                        },
                        "FloatInvoiceVATAmount": {
                            "runAfter": {
                                "Invoice_VAT_Amount": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "FloatInvoiceVATAmount",
                                        "type": "float"
                                    }
                                ]
                            }
                        },
                        "For_Each_Attachment": {
                            "foreach": "@triggerBody()?['attachments']",
                            "actions": {
                                "Is_this_a_PDF_Invoice": {
                                    "actions": {
                                        "Add_a_Error_log_-_Form_Recognizer_failed": {
                                            "runAfter": {
                                                "AnalyzeDocument": [
                                                    "Failed"
                                                ]
                                            },
                                            "type": "ApiConnection",
                                            "inputs": {
                                                "host": {
                                                    "connection": {
                                                        "name": "@parameters('$connections')['commondataservice']['connectionId']"
                                                    }
                                                },
                                                "method": "post",
                                                "body": {
                                                    "eire_documentname": "@item()?['name']",
                                                    "eire_emailsubject": "@triggerBody()?['subject']",
                                                    "eire_errordescription": "Form Recognizer error: @{body('AnalyzeDocument')?['error']?['innererror']?['message']}",
                                                    "eire_errortype": 683430001
                                                },
                                                "headers": {
                                                    "prefer": "return=representation,odata.include-annotations=*",
                                                    "organization": "@parameters('Dataverse URL')"
                                                },
                                                "path": "/api/data/v9.1/@{encodeURIComponent(encodeURIComponent('eire_errorlogs'))}"
                                            }
                                        },
                                        "AnalyzeDocument": {
                                            "type": "ApiConnection",
                                            "inputs": {
                                                "host": {
                                                    "connection": {
                                                        "name": "@parameters('$connections')['formrecognizer']['connectionId']"
                                                    }
                                                },
                                                "method": "post",
                                                "body": "@base64ToBinary(item()?['contentBytes'])",
                                                "path": "/documentModels/@{encodeURIComponent(parameters('Alice Document Intelligence Model Name'))}:analyze",
                                                "queries": {
                                                    "api-version": "2023-07-31",
                                                    "pages": "1"
                                                }
                                            }
                                        },
                                        "Calculate_Min,Avg,Highest_Confidence": {
                                            "actions": {
                                                "Set_Confidence_Max": {
                                                    "runAfter": {
                                                        "Set_Confidence_Min": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "vConfidenceMax",
                                                        "value": "@max(variables('vDocumentTypeConfidence'),variables('vTotalShippingConfidence'),variables('vTotalDiscountConfidence'),variables('vVendorVATRegConfidence'),variables('vVendorNameConfidence'),variables('vInvoiceVATAmountConfidence'),variables('vInvoiceSubTotalConfidence'),variables('vInvoiceTotalConfidence'),variables('vCompanyAddressConfidence'),variables('vCompanyNameConfidence'),variables('vVendorVATRegConfidence'),variables('vVendorNameConfidence'),variables('vVendor Address Confidence'))"
                                                    }
                                                },
                                                "Set_Confidence_Min": {
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "vConfidenceMin",
                                                        "value": "@min(variables('vDocumentTypeConfidence'),variables('vTotalShippingConfidence'),variables('vTotalDiscountConfidence'),variables('vVendorVATRegConfidence'),variables('vVendorNameConfidence'),variables('vInvoiceVATAmountConfidence'),variables('vInvoiceSubTotalConfidence'),variables('vInvoiceTotalConfidence'),variables('vCompanyAddressConfidence'),variables('vCompanyNameConfidence'),variables('vVendorVATRegConfidence'),variables('vVendorNameConfidence'),variables('vVendor Address Confidence'))"
                                                    }
                                                }
                                            },
                                            "runAfter": {
                                                "Fix_Formats": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Scope"
                                        },
                                        "Condition": {
                                            "actions": {
                                                "Create_new_Invoice_Record": {
                                                    "type": "ApiConnection",
                                                    "inputs": {
                                                        "host": {
                                                            "connection": {
                                                                "name": "@parameters('$connections')['commondataservice']['connectionId']"
                                                            }
                                                        },
                                                        "method": "post",
                                                        "body": {
                                                            "eire_invoicedate": "@null",
                                                            "eire_invoiceemailreceiveddatetime": "@triggerBody()?['receivedDateTime']",
                                                            "eire_invoicenumber": "@null",
                                                            "eire_name": "@item()?['name']",
                                                            "statuscode": 683430001,
                                                            "eire_totalamount": "@null",
                                                            "eire_vendorname": "TBC"
                                                        },
                                                        "headers": {
                                                            "prefer": "return=representation,odata.include-annotations=*",
                                                            "organization": "@parameters('Dataverse URL')"
                                                        },
                                                        "path": "/api/data/v9.1/@{encodeURIComponent(encodeURIComponent('eire_invoices'))}"
                                                    }
                                                },
                                                "Set_Next_Step_true": {
                                                    "runAfter": {
                                                        "Create_new_Invoice_Record": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "NextStep",
                                                        "value": true
                                                    }
                                                }
                                            },
                                            "runAfter": {
                                                "Set_Invoice_Variables": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "else": {
                                                "actions": {
                                                    "Add_to_Error_Logs_-_Not_an_Invoice": {
                                                        "type": "ApiConnection",
                                                        "inputs": {
                                                            "host": {
                                                                "connection": {
                                                                    "name": "@parameters('$connections')['commondataservice']['connectionId']"
                                                                }
                                                            },
                                                            "method": "post",
                                                            "body": {
                                                                "eire_documentname": "@item()?['name']",
                                                                "eire_emailsubject": "@triggerBody()?['subject']",
                                                                "eire_errordescription": "Document was not detected to be an Invoice",
                                                                "eire_errortype": 683430001,
                                                                "eire_name": "@variables('vCompanyName')",
                                                                "eire_vendorname": "@variables('vVendorName')"
                                                            },
                                                            "headers": {
                                                                "prefer": "return=representation,odata.include-annotations=*",
                                                                "organization": "@parameters('Dataverse URL')"
                                                            },
                                                            "path": "/api/data/v9.1/@{encodeURIComponent(encodeURIComponent('eire_errorlogs'))}"
                                                        }
                                                    },
                                                    "Update_Next_Step_to_False": {
                                                        "runAfter": {
                                                            "Add_to_Error_Logs_-_Not_an_Invoice": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                            "name": "NextStep",
                                                            "value": false
                                                        }
                                                    }
                                                }
                                            },
                                            "expression": {
                                                "and": [
                                                    {
                                                        "contains": [
                                                            "@toUpper(variables('vDocumentType'))",
                                                            "INVOICE"
                                                        ]
                                                    }
                                                ]
                                            },
                                            "type": "If"
                                        },
                                        "Fix_Formats": {
                                            "actions": {
                                                "Date_Fix_1": {
                                                    "type": "Compose",
                                                    "inputs": "@formatDateTime(variables('vInvoiceDate'),'yyyy-MM-dd')"
                                                },
                                                "Fix_Invoice_Total_Format": {
                                                    "runAfter": {
                                                        "Set_Actual_Date_if_failed": [
                                                            "Succeeded",
                                                            "Skipped",
                                                            "Failed"
                                                        ]
                                                    },
                                                    "type": "Compose",
                                                    "inputs": "@float(if(contains(variables('vInvoiceTotal'), '.'), replace(replace(variables('vInvoiceTotal'), ',', ''), '.', '.'), replace(variables('vInvoiceTotal'), ',', '.')))\r\n"
                                                },
                                                "Fix_Subtotal_Format": {
                                                    "runAfter": {
                                                        "Set_Invoice_Total_format": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Compose",
                                                    "inputs": "@float(if(contains(variables('vInvoiceSubTotal'), '.'), replace(replace(variables('vInvoiceSubTotal'), ',', ''), '.', '.'), replace(variables('vInvoiceSubTotal'), ',', '.')))\r\n",
                                                    "description": "This will fail if the bot does not extract a value. If the value is not detected we will automatically assign the value of 0.00 in Set Subtotal 0.00"
                                                },
                                                "Fix_Vat_Amount_Format": {
                                                    "runAfter": {
                                                        "Set_Subtotal_0.00": [
                                                            "Succeeded",
                                                            "Skipped"
                                                        ],
                                                        "Set_Subtotal_Format": [
                                                            "Succeeded",
                                                            "Skipped"
                                                        ]
                                                    },
                                                    "type": "Compose",
                                                    "inputs": "@float(if(contains(variables('vInvoiceVATAmount'), '.'), replace(replace(variables('vInvoiceVATAmount'), ',', ''), '.', '.'), replace(variables('vInvoiceVATAmount'), ',', '.')))\r\n"
                                                },
                                                "Formats_fixed": {
                                                    "runAfter": {
                                                        "Set_VAT_Amount_to_0.00": [
                                                            "Succeeded",
                                                            "Skipped"
                                                        ],
                                                        "Set_Vat_Amount_Format": [
                                                            "Succeeded",
                                                            "Skipped"
                                                        ]
                                                    },
                                                    "type": "Compose",
                                                    "inputs": "All important field formats been fixed."
                                                },
                                                "Set_Actual_Date": {
                                                    "runAfter": {
                                                        "Date_Fix_1": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "vConvertedInvoiceDate",
                                                        "value": "@outputs('Date_Fix_1')"
                                                    }
                                                },
                                                "Set_Actual_Date_if_failed": {
                                                    "runAfter": {
                                                        "Set_Actual_Date": [
                                                            "Failed",
                                                            "Skipped"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "vConvertedInvoiceDate",
                                                        "value": "@variables('vInvoiceDate')"
                                                    }
                                                },
                                                "Set_Invoice_Total_format": {
                                                    "runAfter": {
                                                        "Fix_Invoice_Total_Format": [
                                                            "Succeeded",
                                                            "Skipped",
                                                            "Failed"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "FloatInvoiceTotal",
                                                        "value": "@outputs('Fix_Invoice_Total_Format')"
                                                    }
                                                },
                                                "Set_Subtotal_0.00": {
                                                    "runAfter": {
                                                        "Fix_Subtotal_Format": [
                                                            "Failed"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "FloatInvoiceSubTotal",
                                                        "value": 0
                                                    }
                                                },
                                                "Set_Subtotal_Format": {
                                                    "runAfter": {
                                                        "Fix_Subtotal_Format": [
                                                            "Succeeded",
                                                            "Skipped"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "FloatInvoiceSubTotal",
                                                        "value": "@outputs('Fix_Subtotal_Format')"
                                                    }
                                                },
                                                "Set_VAT_Amount_to_0.00": {
                                                    "runAfter": {
                                                        "Fix_Vat_Amount_Format": [
                                                            "Failed"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "FloatInvoiceVATAmount",
                                                        "value": 0
                                                    }
                                                },
                                                "Set_Vat_Amount_Format": {
                                                    "runAfter": {
                                                        "Fix_Vat_Amount_Format": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "FloatInvoiceVATAmount",
                                                        "value": "@outputs('Fix_Vat_Amount_Format')"
                                                    }
                                                }
                                            },
                                            "runAfter": {
                                                "Remove_Currency_and_Invalid_Chars": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Scope"
                                        },
                                        "Remove_Currency_and_Invalid_Chars": {
                                            "actions": {
                                                "For_each_Currency_Symbol": {
                                                    "foreach": "@variables('CurrencySymbolsArray')",
                                                    "actions": {
                                                        "Fix_Discount_Currency": {
                                                            "runAfter": {
                                                                "Set_SudTotal_Currency": [
                                                                    "Succeeded",
                                                                    "Failed"
                                                                ]
                                                            },
                                                            "type": "Compose",
                                                            "inputs": "@replace(variables('vTotalDiscount'),items('For_each_Currency_Symbol'),'')"
                                                        },
                                                        "Fix_Invoice_Total_Currency": {
                                                            "runAfter": {
                                                                "Set_Vat_Amount_Currency": [
                                                                    "Succeeded",
                                                                    "Failed"
                                                                ]
                                                            },
                                                            "type": "Compose",
                                                            "inputs": "@replace(variables('vInvoiceTotal'),items('For_each_Currency_Symbol'),'')"
                                                        },
                                                        "Fix_Shipping_Currency": {
                                                            "runAfter": {
                                                                "Set_Discount_Total_Currency": [
                                                                    "Succeeded",
                                                                    "Failed"
                                                                ]
                                                            },
                                                            "type": "Compose",
                                                            "inputs": "@replace(variables('TotalShipping'),items('For_each_Currency_Symbol'),'')"
                                                        },
                                                        "Fix_Subtotal_Currency": {
                                                            "runAfter": {
                                                                "Set_Invoice_Total_Currency": [
                                                                    "Succeeded",
                                                                    "Failed"
                                                                ]
                                                            },
                                                            "type": "Compose",
                                                            "inputs": "@replace(variables('vInvoiceSubTotal'),items('For_each_Currency_Symbol'),'')"
                                                        },
                                                        "Fix_Vat_Amount_Currency": {
                                                            "type": "Compose",
                                                            "inputs": "@replace(variables('vInvoiceVATAmount'),items('For_each_Currency_Symbol'),'')"
                                                        },
                                                        "Set_Discount_Total_Currency": {
                                                            "runAfter": {
                                                                "Fix_Discount_Currency": [
                                                                    "Succeeded",
                                                                    "Failed"
                                                                ]
                                                            },
                                                            "type": "SetVariable",
                                                            "inputs": {
                                                                "name": "vTotalDiscount",
                                                                "value": "@outputs('Fix_Discount_Currency')"
                                                            }
                                                        },
                                                        "Set_Invoice_Total_Currency": {
                                                            "runAfter": {
                                                                "Fix_Invoice_Total_Currency": [
                                                                    "Succeeded",
                                                                    "Failed"
                                                                ]
                                                            },
                                                            "type": "SetVariable",
                                                            "inputs": {
                                                                "name": "vInvoiceTotal",
                                                                "value": "@outputs('Fix_Invoice_Total_Currency')"
                                                            }
                                                        },
                                                        "Set_Shipping_Total_Currency": {
                                                            "runAfter": {
                                                                "Fix_Shipping_Currency": [
                                                                    "Succeeded",
                                                                    "Failed"
                                                                ]
                                                            },
                                                            "type": "SetVariable",
                                                            "inputs": {
                                                                "name": "TotalShipping",
                                                                "value": "@outputs('Fix_Shipping_Currency')"
                                                            }
                                                        },
                                                        "Set_SudTotal_Currency": {
                                                            "runAfter": {
                                                                "Fix_Subtotal_Currency": [
                                                                    "Succeeded",
                                                                    "Failed"
                                                                ]
                                                            },
                                                            "type": "SetVariable",
                                                            "inputs": {
                                                                "name": "vInvoiceSubTotal",
                                                                "value": "@outputs('Fix_Subtotal_Currency')"
                                                            }
                                                        },
                                                        "Set_Vat_Amount_Currency": {
                                                            "runAfter": {
                                                                "Fix_Vat_Amount_Currency": [
                                                                    "Succeeded",
                                                                    "Failed"
                                                                ]
                                                            },
                                                            "type": "SetVariable",
                                                            "inputs": {
                                                                "name": "vInvoiceVATAmount",
                                                                "value": "@outputs('Fix_Vat_Amount_Currency')"
                                                            }
                                                        }
                                                    },
                                                    "runAfter": {
                                                        "For_each_Invalid_Char": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Foreach"
                                                },
                                                "For_each_Invalid_Char": {
                                                    "foreach": "@variables('InvalidCharactersArray')",
                                                    "actions": {
                                                        "Fix_Discount_Total": {
                                                            "runAfter": {
                                                                "Set_Set_Updated_SubTotal": [
                                                                    "Succeeded",
                                                                    "Failed"
                                                                ]
                                                            },
                                                            "type": "Compose",
                                                            "inputs": "@replace(variables('vTotalDiscount'),items('For_each_Invalid_Char'),'')"
                                                        },
                                                        "Fix_Invoice_Total": {
                                                            "runAfter": {
                                                                "Set_Vat_Amount": [
                                                                    "Succeeded",
                                                                    "Failed"
                                                                ]
                                                            },
                                                            "type": "Compose",
                                                            "inputs": "@replace(variables('vInvoiceTotal'),items('For_each_Invalid_Char'),'')"
                                                        },
                                                        "Fix_Shipping_Total": {
                                                            "runAfter": {
                                                                "Set_Updated_Discount_Total": [
                                                                    "Succeeded",
                                                                    "Failed"
                                                                ]
                                                            },
                                                            "type": "Compose",
                                                            "inputs": "@replace(variables('TotalShipping'),items('For_each_Invalid_Char'),'')"
                                                        },
                                                        "Fix_SubTotal": {
                                                            "runAfter": {
                                                                "Set_Updated_Invoice_Total_": [
                                                                    "Succeeded",
                                                                    "Failed"
                                                                ]
                                                            },
                                                            "type": "Compose",
                                                            "inputs": "@replace(variables('vInvoiceSubTotal'),items('For_each_Invalid_Char'),'')"
                                                        },
                                                        "Fix_Vat_Amount": {
                                                            "type": "Compose",
                                                            "inputs": "@replace(variables('vInvoiceVATAmount'),items('For_each_Invalid_Char'),'')"
                                                        },
                                                        "Set_Set_Updated_SubTotal": {
                                                            "runAfter": {
                                                                "Fix_SubTotal": [
                                                                    "Succeeded",
                                                                    "Failed"
                                                                ]
                                                            },
                                                            "type": "SetVariable",
                                                            "inputs": {
                                                                "name": "vInvoiceSubTotal",
                                                                "value": "@outputs('Fix_SubTotal')"
                                                            }
                                                        },
                                                        "Set_Updated_Discount_Total": {
                                                            "runAfter": {
                                                                "Fix_Discount_Total": [
                                                                    "Succeeded",
                                                                    "Failed"
                                                                ]
                                                            },
                                                            "type": "SetVariable",
                                                            "inputs": {
                                                                "name": "vTotalDiscount",
                                                                "value": "@outputs('Fix_Discount_Total')"
                                                            }
                                                        },
                                                        "Set_Updated_Invoice_Total_": {
                                                            "runAfter": {
                                                                "Fix_Invoice_Total": [
                                                                    "Succeeded",
                                                                    "Failed"
                                                                ]
                                                            },
                                                            "type": "SetVariable",
                                                            "inputs": {
                                                                "name": "vInvoiceTotal",
                                                                "value": "@outputs('Fix_Invoice_Total')"
                                                            }
                                                        },
                                                        "Set_Updated_Shipping_Total_": {
                                                            "runAfter": {
                                                                "Fix_Shipping_Total": [
                                                                    "Succeeded",
                                                                    "Failed"
                                                                ]
                                                            },
                                                            "type": "SetVariable",
                                                            "inputs": {
                                                                "name": "TotalShipping",
                                                                "value": "@outputs('Fix_Shipping_Total')"
                                                            }
                                                        },
                                                        "Set_Vat_Amount": {
                                                            "runAfter": {
                                                                "Fix_Vat_Amount": [
                                                                    "Succeeded",
                                                                    "Failed"
                                                                ]
                                                            },
                                                            "type": "SetVariable",
                                                            "inputs": {
                                                                "name": "vInvoiceVATAmount",
                                                                "value": "@outputs('Fix_Vat_Amount')"
                                                            }
                                                        }
                                                    },
                                                    "type": "Foreach"
                                                }
                                            },
                                            "runAfter": {
                                                "Set_Invoice_Scoring_Variables": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Scope"
                                        },
                                        "Set_Adaptive_Card_-_Unrognized-copy": {
                                            "runAfter": {
                                                "Add_a_Error_log_-_Form_Recognizer_failed": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "SetVariable",
                                            "inputs": {
                                                "name": "Adaptive Card",
                                                "value": {
                                                    "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                                                    "body": [
                                                        {
                                                            "columns": [
                                                                {
                                                                    "items": [
                                                                        {
                                                                            "size": "large",
                                                                            "text": "Invoice # @{item()?['name']}",
                                                                            "type": "TextBlock",
                                                                            "weight": "bolder",
                                                                            "wrap": true
                                                                        }
                                                                    ],
                                                                    "type": "Column",
                                                                    "width": "stretch"
                                                                },
                                                                {
                                                                    "items": [
                                                                        {
                                                                            "color": "warning",
                                                                            "horizontalAlignment": "right",
                                                                            "text": "Status: Failed",
                                                                            "type": "TextBlock",
                                                                            "weight": "bolder",
                                                                            "wrap": true
                                                                        }
                                                                    ],
                                                                    "type": "Column",
                                                                    "width": "stretch"
                                                                }
                                                            ],
                                                            "type": "ColumnSet"
                                                        },
                                                        {
                                                            "text": "Document Inteligence encountered an error while processing the invoice from . Try resend the invoice again. If the problem presists contact the IT Department",
                                                            "type": "TextBlock",
                                                            "wrap": true
                                                        }
                                                    ],
                                                    "type": "AdaptiveCard",
                                                    "version": "1.6"
                                                }
                                            }
                                        },
                                        "Set_Invoice_Scoring_Variables": {
                                            "actions": {
                                                "Set_Company_Name_Confidence": {
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "vCompanyNameConfidence",
                                                        "value": "@outputs('AnalyzeDocument')?['body/analyzeResult/documents'][0]['fields']['CustomerName']['confidence']"
                                                    }
                                                },
                                                "Set_Customer_Address_Confidence": {
                                                    "runAfter": {
                                                        "Set_Company_Name_Confidence": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "vCompanyAddressConfidence",
                                                        "value": "@outputs('AnalyzeDocument')?['body/analyzeResult/documents'][0]['fields']?['CustomerAddress']?['confidence']"
                                                    }
                                                },
                                                "Set_Document_Type_Confidence": {
                                                    "runAfter": {
                                                        "Set_Shipping_Total_Confidence": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "vDocumentTypeConfidence",
                                                        "value": "@outputs('AnalyzeDocument')?['body/analyzeResult/documents'][0]['fields']?['DocumentType']?['confidence']"
                                                    }
                                                },
                                                "Set_Invoice_Date_Confidence": {
                                                    "runAfter": {
                                                        "Set_PO_Number_Confidence": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "vInvoiceDateConfidence",
                                                        "value": "@outputs('AnalyzeDocument')?['body/analyzeResult/documents'][0]['fields']?['InvoiceDate']?['confidence']"
                                                    }
                                                },
                                                "Set_Invoice_Number_Confidence": {
                                                    "runAfter": {
                                                        "Set_Invoice_Date_Confidence": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "vInvoiceNumberConfidence",
                                                        "value": "@outputs('AnalyzeDocument')?['body/analyzeResult/documents'][0]['fields']?['InvoiceNumber']?['confidence']"
                                                    }
                                                },
                                                "Set_Invoice_Total_Confidence": {
                                                    "runAfter": {
                                                        "Set_Invoice_Number_Confidence": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "vInvoiceTotalConfidence",
                                                        "value": "@outputs('AnalyzeDocument')?['body/analyzeResult/documents'][0]['fields']?['InvoiceTotal']?['confidence']"
                                                    }
                                                },
                                                "Set_PO_Number_Confidence": {
                                                    "runAfter": {
                                                        "Set_Vendor_Address_Confidence": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "vPONumberConfidence",
                                                        "value": "@outputs('AnalyzeDocument')?['body/analyzeResult/documents'][0]['fields']?['PONumber']?['confidence']"
                                                    }
                                                },
                                                "Set_Shipping_Total_Confidence": {
                                                    "runAfter": {
                                                        "Set_SubTotal_Confidence": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "vTotalShippingConfidence",
                                                        "value": "@outputs('AnalyzeDocument')?['body/analyzeResult/documents'][0]['fields']['ShippingTotal']?['confidence']"
                                                    }
                                                },
                                                "Set_SubTotal_Confidence": {
                                                    "runAfter": {
                                                        "Set_Invoice_Total_Confidence": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "vInvoiceSubTotalConfidence",
                                                        "value": "@outputs('AnalyzeDocument')?['body/analyzeResult/documents'][0]['fields']?['SubTotal']?['confidence']"
                                                    }
                                                },
                                                "Set_Total_Discount_Confidence": {
                                                    "runAfter": {
                                                        "Set_Vendor_VAT_Reg": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "vTotalDiscountConfidence",
                                                        "value": "@outputs('AnalyzeDocument')?['body/analyzeResult/documents'][0]['fields']?['TotalDiscount']?['confidence']"
                                                    }
                                                },
                                                "Set_VAT_Amount_Confidence": {
                                                    "runAfter": {
                                                        "Set_Total_Discount_Confidence": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "vInvoiceVATAmountConfidence",
                                                        "value": "@outputs('AnalyzeDocument')?['body/analyzeResult/documents'][0]['fields']?['VATAmount']?['confidence']"
                                                    }
                                                },
                                                "Set_Vendor_Address_Confidence": {
                                                    "runAfter": {
                                                        "Set_Vendor_Name_Confidence": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "vVendor Address Confidence",
                                                        "value": "@outputs('AnalyzeDocument')?['body/analyzeResult/documents'][0]['fields']?['VendorAddress']?['confidence']"
                                                    }
                                                },
                                                "Set_Vendor_Name_Confidence": {
                                                    "runAfter": {
                                                        "Set_Customer_Address_Confidence": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "vVendorNameConfidence",
                                                        "value": "@outputs('AnalyzeDocument')?['body/analyzeResult/documents'][0]['fields']?['VendorName']?['confidence']"
                                                    }
                                                },
                                                "Set_Vendor_VAT_Reg": {
                                                    "runAfter": {
                                                        "Set_Document_Type_Confidence": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "vVendorVATRegConfidence",
                                                        "value": "@outputs('AnalyzeDocument')?['body/analyzeResult/documents'][0]['fields']['VendorVATReg']?['confidence']"
                                                    }
                                                }
                                            },
                                            "runAfter": {
                                                "Condition": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Scope"
                                        },
                                        "Set_Invoice_Variables": {
                                            "actions": {
                                                "Set_Company_Name": {
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "vCompanyName",
                                                        "value": "@outputs('AnalyzeDocument')?['body/analyzeResult/documents'][0]['fields']?['CustomerName']?['valueString']"
                                                    }
                                                },
                                                "Set_Customer_Address": {
                                                    "runAfter": {
                                                        "Set_Company_Name": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "vCompanyAddress",
                                                        "value": "@outputs('AnalyzeDocument')?['body/analyzeResult/documents'][0]['fields']?['CustomerAdress']?['valueString']"
                                                    }
                                                },
                                                "Set_Document_Type": {
                                                    "runAfter": {
                                                        "Set_Invoice_SubTotal": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "vDocumentType",
                                                        "value": "@outputs('AnalyzeDocument')?['body/analyzeResult/documents'][0]['fields']?['DocumentType']?['valueString']"
                                                    }
                                                },
                                                "Set_Invoice_Date": {
                                                    "runAfter": {
                                                        "Set_VendorAddress": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "vInvoiceDate",
                                                        "value": "@outputs('AnalyzeDocument')?['body/analyzeResult/documents'][0]['fields']?['InvoiceDate']?['valueString']"
                                                    }
                                                },
                                                "Set_Invoice_Number": {
                                                    "runAfter": {
                                                        "Set_Invoice_Date": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "vInvoiceNumber",
                                                        "value": "@if(equals(outputs('AnalyzeDocument')?['body/analyzeResult/documents'][0]['fields']?['InvoiceNumber']?['valueString'], null), 'Unknown', outputs('AnalyzeDocument')?['body/analyzeResult/documents'][0]['fields']?['InvoiceNumber']?['valueString'])\r\n"
                                                    }
                                                },
                                                "Set_Invoice_SubTotal": {
                                                    "runAfter": {
                                                        "Set_Invoice_Total": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "vInvoiceSubTotal",
                                                        "value": "@outputs('AnalyzeDocument')?['body/analyzeResult/documents'][0]['fields']?['SubTotal']?['valueString']"
                                                    }
                                                },
                                                "Set_Invoice_Total": {
                                                    "runAfter": {
                                                        "Set_Invoice_Number": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "vInvoiceTotal",
                                                        "value": "@outputs('AnalyzeDocument')?['body/analyzeResult/documents'][0]['fields']?['InvoiceTotal']?['valueString']"
                                                    }
                                                },
                                                "Set_Invoice_VAT_Amount": {
                                                    "runAfter": {
                                                        "Set_Total_Discount": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "vInvoiceVATAmount",
                                                        "value": "@outputs('AnalyzeDocument')?['body/analyzeResult/documents'][0]['fields']?['VATAmount']?['valueString']"
                                                    }
                                                },
                                                "Set_PO_Number": {
                                                    "runAfter": {
                                                        "Set_Document_Type": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "vPONumber",
                                                        "value": "@outputs('AnalyzeDocument')?['body/analyzeResult/documents'][0]['fields']?['PONumber']?['valueString']"
                                                    }
                                                },
                                                "Set_Shipping_Total": {
                                                    "runAfter": {
                                                        "Set_PO_Number": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "TotalShipping",
                                                        "value": "@outputs('AnalyzeDocument')?['body/analyzeResult/documents'][0]['fields']?['ShippingTotal']?['valueString']"
                                                    }
                                                },
                                                "Set_Total_Discount": {
                                                    "runAfter": {
                                                        "Set_Shipping_Total": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "vTotalDiscount",
                                                        "value": "@outputs('AnalyzeDocument')?['body/analyzeResult/documents'][0]['fields']['TotalDiscount']?['valueString']"
                                                    }
                                                },
                                                "Set_VendorAddress": {
                                                    "runAfter": {
                                                        "Set_VendorName": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "vVendorAddress",
                                                        "value": "@outputs('AnalyzeDocument')?['body/analyzeResult/documents'][0]['fields']?['VendorAddress']?['valueString']"
                                                    }
                                                },
                                                "Set_VendorName": {
                                                    "runAfter": {
                                                        "Set_Customer_Address": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "vVendorName",
                                                        "value": "@outputs('AnalyzeDocument')?['body/analyzeResult/documents'][0]['fields']?['VendorName']?['valueString']"
                                                    }
                                                }
                                            },
                                            "runAfter": {
                                                "AnalyzeDocument": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Scope"
                                        }
                                    },
                                    "else": {
                                        "actions": {
                                            "Add_a_Error_log_-_Invalid_File_Type": {
                                                "runAfter": {
                                                    "Invoice_is_not_PDF": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "ApiConnection",
                                                "inputs": {
                                                    "host": {
                                                        "connection": {
                                                            "name": "@parameters('$connections')['commondataservice']['connectionId']"
                                                        }
                                                    },
                                                    "method": "post",
                                                    "body": {
                                                        "eire_documentname": "@item()?['name']",
                                                        "eire_emailsubject": "@triggerBody()?['subject']",
                                                        "eire_errordescription": "File provided was not a valid PDF Invoice",
                                                        "eire_errortype": 683430001
                                                    },
                                                    "headers": {
                                                        "prefer": "return=representation,odata.include-annotations=*",
                                                        "organization": "@parameters('Dataverse URL')"
                                                    },
                                                    "path": "/api/data/v9.1/@{encodeURIComponent(encodeURIComponent('eire_errorlogs'))}"
                                                }
                                            },
                                            "Decrement_TotalAttachments": {
                                                "runAfter": {
                                                    "Add_a_Error_log_-_Invalid_File_Type": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "DecrementVariable",
                                                "inputs": {
                                                    "name": "TotalAttachments",
                                                    "value": 1
                                                },
                                                "description": "We are reducing the total attachments count, as sometimes email signatures with images are counted as attachments"
                                            },
                                            "Invoice_is_not_PDF": {
                                                "type": "Compose",
                                                "inputs": "@{item()?['name']} is not a PDF invoice"
                                            },
                                            "Set_Next_Step_false": {
                                                "runAfter": {
                                                    "Decrement_TotalAttachments": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "NextStep",
                                                    "value": false
                                                }
                                            },
                                            "Send_Adative_Card_-_No": {
                                                "runAfter": {
                                                    "Set_Next_Step_false": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "SendAdaptiveCard",
                                                    "value": "No"
                                                }
                                            }
                                        }
                                    },
                                    "expression": {
                                        "or": [
                                            {
                                                "endsWith": [
                                                    "@items('For_Each_Attachment')?['name']",
                                                    ".pdf"
                                                ]
                                            },
                                            {
                                                "endsWith": [
                                                    "@item()?['name']",
                                                    ".PDF"
                                                ]
                                            }
                                        ]
                                    },
                                    "type": "If"
                                },
                                "Was_a_valid_Invoice": {
                                    "actions": {
                                        "For_each": {
                                            "foreach": "@outputs('AnalyzeDocument')?['body/analyzeResult/documents'][0]['fields']['Items']['valueArray']\r\n",
                                            "actions": {
                                                "Add_a_new_row": {
                                                    "type": "ApiConnection",
                                                    "inputs": {
                                                        "host": {
                                                            "connection": {
                                                                "name": "@parameters('$connections')['commondataservice']['connectionId']"
                                                            }
                                                        },
                                                        "method": "post",
                                                        "body": {
                                                            "eire_description": "@{items('For_each')['valueObject']?['Description']?['valueString']}",
                                                            "eire_quantity": "@items('For_each')['valueObject']?['Quantity']?['valueString']",
                                                            "eire_totalprice": "@items('For_each')['valueObject']?['Amount']?['valueString']",
                                                            "eire_InvoiceID@odata.bind": "Invoices(@{body('Create_new_Invoice_Record')?['eire_invoiceid']})",
                                                            "eire_unitprice": "@items('For_each')['valueObject']?['UnitPrice']?['valueString']",
                                                            "eire_vatamount": "@items('For_each')['valueObject']?['VATAmount']?['valueString']"
                                                        },
                                                        "headers": {
                                                            "prefer": "return=representation,odata.include-annotations=*",
                                                            "organization": "https://alicedev.crm4.dynamics.com"
                                                        },
                                                        "path": "/api/data/v9.1/@{encodeURIComponent(encodeURIComponent('eire_invoicelineitems'))}"
                                                    }
                                                }
                                            },
                                            "runAfter": {
                                                "Update_a_row": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Foreach"
                                        },
                                        "Setting_the_Status": {
                                            "actions": {
                                                "Increment_Processed_Invoice_Value": {
                                                    "runAfter": {
                                                        "Set_Colour_-_Good": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "IncrementVariable",
                                                    "inputs": {
                                                        "name": "vTotalProcessedInvoices",
                                                        "value": 1
                                                    }
                                                },
                                                "Set_Adaptive_Card_-_Recognized": {
                                                    "runAfter": {
                                                        "Increment_Processed_Invoice_Value": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "Adaptive Card",
                                                        "value": {
                                                            "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                                                            "actions": [
                                                                {
                                                                    "title": "Open invoice",
                                                                    "type": "Action.OpenUrl",
                                                                    "url": "https://alicedev.crm4.dynamics.com/main.aspx?appid=@{parameters('Monder Driven App ID')}&pagetype=entityrecord&etn=eire_invoice&id=@{body('Create_new_Invoice_Record')?['eire_invoiceid']}"
                                                                }
                                                            ],
                                                            "body": [
                                                                {
                                                                    "columns": [
                                                                        {
                                                                            "items": [
                                                                                {
                                                                                    "size": "Large",
                                                                                    "text": "Invoice # @{item()?['name']}",
                                                                                    "type": "TextBlock",
                                                                                    "weight": "Bolder",
                                                                                    "wrap": true
                                                                                }
                                                                            ],
                                                                            "type": "Column",
                                                                            "width": "stretch"
                                                                        },
                                                                        {
                                                                            "items": [
                                                                                {
                                                                                    "color": "@{variables('StatusColor')}",
                                                                                    "fontType": "Default",
                                                                                    "horizontalAlignment": "Right",
                                                                                    "isSubtle": false,
                                                                                    "size": "Default",
                                                                                    "style": "default",
                                                                                    "text": "Status: Processed",
                                                                                    "type": "TextBlock",
                                                                                    "weight": "Bolder",
                                                                                    "wrap": true
                                                                                },
                                                                                {
                                                                                    "height": "88px",
                                                                                    "horizontalAlignment": "Right",
                                                                                    "selectAction": {
                                                                                        "type": "Action.OpenUrl",
                                                                                        "url": "https://evrosdemo.sharepoint.com/teams/AliceDev@{body('Create_file')?['Path']}"
                                                                                    },
                                                                                    "type": "Image",
                                                                                    "url": "https://evrosdemo.sharepoint.com/teams/AliceDev@{body('Create_file')?['Path']}",
                                                                                    "width": "66px"
                                                                                }
                                                                            ],
                                                                            "type": "Column",
                                                                            "width": "stretch"
                                                                        }
                                                                    ],
                                                                    "type": "ColumnSet"
                                                                },
                                                                {
                                                                    "label": "Name",
                                                                    "placeholder": "Enter Filename",
                                                                    "type": "Input.Text",
                                                                    "value": "@{item()?['name']}"
                                                                },
                                                                {
                                                                    "label": "Vendor name",
                                                                    "placeholder": "Enter Vendor Name",
                                                                    "type": "Input.Text",
                                                                    "value": "@{variables('vVendorName')}"
                                                                },
                                                                {
                                                                    "label": "Company name",
                                                                    "maxLength": 200,
                                                                    "placeholder": "Enter Company Name",
                                                                    "type": "Input.Text",
                                                                    "value": "@{variables('vCompanyName')}"
                                                                },
                                                                {
                                                                    "id": "invoiceNumber",
                                                                    "label": "Invoice Number",
                                                                    "maxLength": 200,
                                                                    "placeholder": "Entert Invoice Number",
                                                                    "type": "Input.Text",
                                                                    "value": "@{variables('vInvoiceNumber')}"
                                                                },
                                                                {
                                                                    "label": "Invoice date",
                                                                    "placeholder": "Detected Invoice @{variables('vInvoiceDate')}",
                                                                    "type": "Input.Date",
                                                                    "value": "@{variables('vInvoiceDate')}"
                                                                },
                                                                {
                                                                    "label": "Invoice emails received date",
                                                                    "placeholder": "Enter Invoice Email Received Date",
                                                                    "type": "Input.Date",
                                                                    "value": "@{formatDateTime(triggerBody()?['receivedDateTime'],'yyyy-mm-dd')}"
                                                                },
                                                                {
                                                                    "label": "Vendor VAT number",
                                                                    "placeholder": "Enter Vendor VAT Number",
                                                                    "type": "Input.Text",
                                                                    "value": "@{variables('vVendorVATReg')}"
                                                                },
                                                                {
                                                                    "label": "Total amount",
                                                                    "placeholder": "Enter Total Amount",
                                                                    "type": "Input.Text",
                                                                    "value": "@{variables('vInvoiceTotal')}"
                                                                },
                                                                {
                                                                    "label": "PO number",
                                                                    "placeholder": "Enter PO Number",
                                                                    "type": "Input.Text",
                                                                    "value": "@{variables('vPONumber')}"
                                                                },
                                                                {
                                                                    "label": "Owner",
                                                                    "placeholder": "Enter Owner Name",
                                                                    "type": "Input.Text",
                                                                    "value": "@{triggerBody()?['from']}"
                                                                },
                                                                {
                                                                    "id": "InvoiceId",
                                                                    "isVisible": false,
                                                                    "type": "Input.Text",
                                                                    "value": "@{body('Create_new_Invoice_Record')?['eire_invoiceid']}"
                                                                }
                                                            ],
                                                            "minHeight": "2px",
                                                            "rtl": false,
                                                            "type": "AdaptiveCard",
                                                            "version": "1.6",
                                                            "verticalContentAlignment": "Top"
                                                        }
                                                    }
                                                },
                                                "Set_Colour_-_Good": {
                                                    "runAfter": {
                                                        "Set_Status_Actual_Name_-_Processed": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "StatusColor",
                                                        "value": "Good"
                                                    }
                                                },
                                                "Set_Status_Actual_Name_-_Processed": {
                                                    "runAfter": {
                                                        "Set_Status_Name_-_Processed": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "StatusActualName",
                                                        "value": "Processed"
                                                    }
                                                },
                                                "Set_Status_Name_-_Processed": {
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "vStatusName",
                                                        "value": 683430002
                                                    },
                                                    "description": "683430002 = Processed"
                                                }
                                            },
                                            "else": {
                                                "actions": {
                                                    "Is_Vendor_and_Company_Detected": {
                                                        "actions": {
                                                            "Increment_Total_Processed_Invoice_": {
                                                                "runAfter": {
                                                                    "Set_Color_Warning": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "IncrementVariable",
                                                                "inputs": {
                                                                    "name": "vTotalProcessedInvoices",
                                                                    "value": 1
                                                                },
                                                                "description": "As the invoice is a rejected state, this means the invoice as rejected by the system for Validation issues. This must count towards the total invoices processed."
                                                            },
                                                            "Set_Adaptive_Card_-_Rejected": {
                                                                "runAfter": {
                                                                    "Increment_Total_Processed_Invoice_": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "SetVariable",
                                                                "inputs": {
                                                                    "name": "Adaptive Card",
                                                                    "value": {
                                                                        "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                                                                        "actions": [
                                                                            {
                                                                                "data": {
                                                                                    "actionType": "submitInvoice",
                                                                                    "source": "adaptiveCard"
                                                                                },
                                                                                "id": "updateInvoiceButton",
                                                                                "isVisible": false,
                                                                                "title": "Update Invoice",
                                                                                "type": "Action.Submit"
                                                                            }
                                                                        ],
                                                                        "body": [
                                                                            {
                                                                                "columns": [
                                                                                    {
                                                                                        "items": [
                                                                                            {
                                                                                                "size": "Large",
                                                                                                "text": "Invoice # @{item()?['name']}",
                                                                                                "type": "TextBlock",
                                                                                                "weight": "Bolder",
                                                                                                "wrap": true
                                                                                            }
                                                                                        ],
                                                                                        "type": "Column",
                                                                                        "width": "stretch"
                                                                                    },
                                                                                    {
                                                                                        "items": [
                                                                                            {
                                                                                                "color": "@{variables('StatusColor')}",
                                                                                                "horizontalAlignment": "Right",
                                                                                                "isSubtle": false,
                                                                                                "size": "Default",
                                                                                                "style": "default",
                                                                                                "text": "Status: Rejected",
                                                                                                "type": "TextBlock",
                                                                                                "weight": "Bolder",
                                                                                                "wrap": true
                                                                                            },
                                                                                            {
                                                                                                "height": "88px",
                                                                                                "horizontalAlignment": "Right",
                                                                                                "selectAction": {
                                                                                                    "type": "Action.OpenUrl",
                                                                                                    "url": "https://evrosdemo.sharepoint.com/teams/AliceDev@{body('Create_file')?['Path']}"
                                                                                                },
                                                                                                "type": "Image",
                                                                                                "url": "https://evrosdemo.sharepoint.com/teams/AliceDev@{body('Create_file')?['Path']}",
                                                                                                "width": "66px"
                                                                                            }
                                                                                        ],
                                                                                        "type": "Column",
                                                                                        "width": "stretch"
                                                                                    }
                                                                                ],
                                                                                "type": "ColumnSet"
                                                                            },
                                                                            {
                                                                                "id": "inputFieldsContainer",
                                                                                "isVisible": true,
                                                                                "items": [
                                                                                    {
                                                                                        "id": "invoiceNumber",
                                                                                        "label": "Name",
                                                                                        "placeholder": "Enter Filename",
                                                                                        "type": "Input.Text",
                                                                                        "value": "@{item()?['name']}"
                                                                                    },
                                                                                    {
                                                                                        "IsRequired": true,
                                                                                        "errorMessage": "Vendor Name is required",
                                                                                        "id": "VendorName",
                                                                                        "label": "Vendor name",
                                                                                        "placeholder": "Enter Vendor Name",
                                                                                        "type": "Input.Text",
                                                                                        "value": "@{variables('vVendorName')}"
                                                                                    },
                                                                                    {
                                                                                        "IsRequired": true,
                                                                                        "errorMessage": "Compnay Name is required",
                                                                                        "id": "CompanyName",
                                                                                        "label": "Company name",
                                                                                        "maxLength": 200,
                                                                                        "placeholder": "Enter Company Name",
                                                                                        "type": "Input.Text",
                                                                                        "value": "@{variables('vCompanyName')}"
                                                                                    },
                                                                                    {
                                                                                        "IsRequired": true,
                                                                                        "errorMessage": "Invoice Number is required",
                                                                                        "id": "InvoiceNumber",
                                                                                        "label": "Invoice Number",
                                                                                        "maxLength": 200,
                                                                                        "placeholder": "Enter Invoice Number",
                                                                                        "type": "Input.Text",
                                                                                        "value": "@{variables('vInvoiceNumber')}"
                                                                                    },
                                                                                    {
                                                                                        "IsRequired": true,
                                                                                        "errorMessage": "Invoice Date is required",
                                                                                        "id": "InvoiceDate",
                                                                                        "label": "Invoice date",
                                                                                        "placeholder": "Enter Invoice Date",
                                                                                        "type": "Input.Date",
                                                                                        "value": "@{variables('vInvoiceDate')}"
                                                                                    },
                                                                                    {
                                                                                        "IsRequired": true,
                                                                                        "errorMessage": "Invoice Date is required",
                                                                                        "id": "InvoiceEmailReceivedDate",
                                                                                        "label": "Invoice email received date",
                                                                                        "placeholder": "Enter Invoice Email Received Date",
                                                                                        "type": "Input.Date",
                                                                                        "value": "@{formatDateTime(triggerBody()?['receivedDateTime'],'yyyy-mm-dd')}"
                                                                                    },
                                                                                    {
                                                                                        "IsRequired": true,
                                                                                        "errorMessage": "VAT Registration Number is required",
                                                                                        "id": "VendorVATNumber",
                                                                                        "label": "Vendor VAT number",
                                                                                        "placeholder": "Enter Vendor VAT Number",
                                                                                        "type": "Input.Text",
                                                                                        "value": "@{variables('vVendorVATReg')}"
                                                                                    },
                                                                                    {
                                                                                        "IsRequired": true,
                                                                                        "errorMessage": "Invoice Total Amount is required",
                                                                                        "id": "TotalAmount",
                                                                                        "label": "Total amount",
                                                                                        "placeholder": "Enter Total Amount",
                                                                                        "type": "Input.Text",
                                                                                        "value": "@{variables('vInvoiceTotal')}"
                                                                                    },
                                                                                    {
                                                                                        "IsRequired": true,
                                                                                        "errorMessage": "PO Number is required",
                                                                                        "id": "PONumber",
                                                                                        "label": "PO number",
                                                                                        "placeholder": "Enter PO Number",
                                                                                        "type": "Input.Text",
                                                                                        "value": "@{variables('vPONumber')}"
                                                                                    },
                                                                                    {
                                                                                        "IsRequired": true,
                                                                                        "errorMessage": "Owner is required",
                                                                                        "id": "owner",
                                                                                        "label": "Owner",
                                                                                        "placeholder": "Enter Owner Name",
                                                                                        "type": "Input.Text",
                                                                                        "value": "@{triggerBody()?['from']}"
                                                                                    },
                                                                                    {
                                                                                        "id": "invoiceId",
                                                                                        "isVisible": false,
                                                                                        "type": "Input.Text",
                                                                                        "value": "@{body('Create_new_Invoice_Record')?['eire_invoiceid']}"
                                                                                    }
                                                                                ],
                                                                                "type": "Container"
                                                                            }
                                                                        ],
                                                                        "type": "AdaptiveCard",
                                                                        "version": "1.6"
                                                                    }
                                                                }
                                                            },
                                                            "Set_Color_Warning": {
                                                                "runAfter": {
                                                                    "Set_Status_Actual_Name_-_Rejected": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "SetVariable",
                                                                "inputs": {
                                                                    "name": "StatusColor",
                                                                    "value": "Warning"
                                                                }
                                                            },
                                                            "Set_Status_Actual_Name_-_Rejected": {
                                                                "runAfter": {
                                                                    "Set_Status_Name_-_Rejected": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "SetVariable",
                                                                "inputs": {
                                                                    "name": "StatusActualName",
                                                                    "value": "Rejected"
                                                                }
                                                            },
                                                            "Set_Status_Name_-_Rejected": {
                                                                "type": "SetVariable",
                                                                "inputs": {
                                                                    "name": "vStatusName",
                                                                    "value": 683430003
                                                                }
                                                            }
                                                        },
                                                        "else": {
                                                            "actions": {
                                                                "Add_to_Error_Logs": {
                                                                    "type": "ApiConnection",
                                                                    "inputs": {
                                                                        "host": {
                                                                            "connection": {
                                                                                "name": "@parameters('$connections')['commondataservice']['connectionId']"
                                                                            }
                                                                        },
                                                                        "method": "post",
                                                                        "body": {
                                                                            "eire_documentname": "@item()?['name']",
                                                                            "eire_emailsubject": "@triggerBody()?['subject']",
                                                                            "eire_errordescription": "Company Name or Vendor Name was not detected by Alice. Please train the invoice",
                                                                            "eire_errortype": 683430001,
                                                                            "eire_InvoiceID@odata.bind": "@body('Create_new_Invoice_Record')?['@odata.id']",
                                                                            "eire_invoicenumber": "@body('Create_new_Invoice_Record')?['eire_invoicenumber']",
                                                                            "statuscode": 1,
                                                                            "eire_name": "@variables('vCompanyName')",
                                                                            "eire_vendorname": "@variables('vVendorName')"
                                                                        },
                                                                        "headers": {
                                                                            "prefer": "return=representation,odata.include-annotations=*",
                                                                            "organization": "@parameters('Dataverse URL')"
                                                                        },
                                                                        "path": "/api/data/v9.1/@{encodeURIComponent(encodeURIComponent('eire_errorlogs'))}"
                                                                    },
                                                                    "description": "The Document is missing Vendor Name or Company name on the invoices"
                                                                },
                                                                "Reduce_Total_Attachments_": {
                                                                    "runAfter": {
                                                                        "Add_to_Error_Logs": [
                                                                            "Succeeded"
                                                                        ]
                                                                    },
                                                                    "type": "IncrementVariable",
                                                                    "inputs": {
                                                                        "name": "TotalAttachments",
                                                                        "value": -1
                                                                    },
                                                                    "description": "We reduce the total attachments as we want to ensure the total invoices Processed is correct when moving the email to their folders. Because this failed at the start we will reduce. "
                                                                },
                                                                "Set_Adaptive_Card_-_Unrognized": {
                                                                    "runAfter": {
                                                                        "Set_Status_Name_-_Failed": [
                                                                            "Succeeded"
                                                                        ]
                                                                    },
                                                                    "type": "SetVariable",
                                                                    "inputs": {
                                                                        "name": "Adaptive Card",
                                                                        "value": {
                                                                            "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                                                                            "type": "AdaptiveCard",
                                                                            "version": "1.6",
                                                                            "body": [
                                                                                {
                                                                                    "type": "ColumnSet",
                                                                                    "columns": [
                                                                                        {
                                                                                            "type": "Column",
                                                                                            "width": "stretch",
                                                                                            "items": [
                                                                                                {
                                                                                                    "type": "TextBlock",
                                                                                                    "text": "Invoice # @{body('Convert_PDF_to_JPG')?['Filename']}",
                                                                                                    "wrap": true,
                                                                                                    "size": "large",
                                                                                                    "weight": "bolder"
                                                                                                }
                                                                                            ]
                                                                                        },
                                                                                        {
                                                                                            "type": "Column",
                                                                                            "width": "stretch",
                                                                                            "items": [
                                                                                                {
                                                                                                    "type": "TextBlock",
                                                                                                    "text": "Status Rejected",
                                                                                                    "wrap": true,
                                                                                                    "color": "warning",
                                                                                                    "weight": "bolder",
                                                                                                    "horizontalAlignment": "right"
                                                                                                },
                                                                                                {
                                                                                                    "type": "Image",
                                                                                                    "horizontalAlignment": "Right",
                                                                                                    "id": "invoiceImage",
                                                                                                    "url": "https://evrosdemo.sharepoint.com/teams/AliceDev@{body('Create_file')?['Path']}",
                                                                                                    "width": "66px",
                                                                                                    "height": "88px",
                                                                                                    "selectAction": {
                                                                                                        "type": "Action.OpenUrl",
                                                                                                        "url": "https://evrosdemo.sharepoint.com/teams/AliceDev@{body('Create_file')?['Path']}"
                                                                                                    }
                                                                                                }
                                                                                            ]
                                                                                        }
                                                                                    ]
                                                                                },
                                                                                {
                                                                                    "type": "TextBlock",
                                                                                    "text": "An issue was encountered while processing the invoice from [Vendor Name]. Would you like to assist with resolving this?",
                                                                                    "wrap": true
                                                                                },
                                                                                {
                                                                                    "type": "Input.Text",
                                                                                    "id": "InvoiceId",
                                                                                    "isVisible": false,
                                                                                    "value": "@{body('Create_new_Invoice_Record')?['eire_invoiceid']}"
                                                                                },
                                                                                {
                                                                                    "type": "Input.Text",
                                                                                    "id": "Invoice_Image",
                                                                                    "isVisible": false,
                                                                                    "value": "https://evrosdemo.sharepoint.com/teams/AliceDev@{body('Create_file')?['Path']}"
                                                                                }
                                                                            ],
                                                                            "actions": [
                                                                                {
                                                                                    "type": "Action.Submit",
                                                                                    "title": "Yes",
                                                                                    "data": {
                                                                                        "source": "adaptiveCard",
                                                                                        "actionType": "userChoiceSubmit",
                                                                                        "choice": "yes"
                                                                                    }
                                                                                },
                                                                                {
                                                                                    "type": "Action.Submit",
                                                                                    "title": "No",
                                                                                    "data": {
                                                                                        "source": "adaptiveCard",
                                                                                        "actionType": "userChoiceSubmit",
                                                                                        "choice": "no"
                                                                                    }
                                                                                },
                                                                                {
                                                                                    "type": "Action.Submit",
                                                                                    "title": "Ask me again tomorrow",
                                                                                    "data": {
                                                                                        "source": "adaptiveCard",
                                                                                        "actionType": "userChoiceSubmit",
                                                                                        "choice": "askTomorrow"
                                                                                    }
                                                                                },
                                                                                {
                                                                                    "type": "Action.Submit",
                                                                                    "title": "Ask me again in 3 business days",
                                                                                    "data": {
                                                                                        "source": "adaptiveCard",
                                                                                        "actionType": "userChoiceSubmit",
                                                                                        "choice": "ask3Days"
                                                                                    }
                                                                                }
                                                                            ]
                                                                        }
                                                                    }
                                                                },
                                                                "Set_Status_Actual_NAme_-Failed": {
                                                                    "runAfter": {
                                                                        "Reduce_Total_Attachments_": [
                                                                            "Succeeded"
                                                                        ]
                                                                    },
                                                                    "type": "SetVariable",
                                                                    "inputs": {
                                                                        "name": "StatusActualName",
                                                                        "value": "Failed"
                                                                    }
                                                                },
                                                                "Set_Status_Color_-_Attention": {
                                                                    "runAfter": {
                                                                        "Set_Status_Actual_NAme_-Failed": [
                                                                            "Succeeded"
                                                                        ]
                                                                    },
                                                                    "type": "SetVariable",
                                                                    "inputs": {
                                                                        "name": "StatusColor",
                                                                        "value": "Attention"
                                                                    }
                                                                },
                                                                "Set_Status_Name_-_Failed": {
                                                                    "runAfter": {
                                                                        "Set_Status_Color_-_Attention": [
                                                                            "Succeeded"
                                                                        ]
                                                                    },
                                                                    "type": "SetVariable",
                                                                    "inputs": {
                                                                        "name": "vStatusName",
                                                                        "value": 683430004
                                                                    },
                                                                    "description": "683430004 = Failed"
                                                                }
                                                            }
                                                        },
                                                        "expression": {
                                                            "and": [
                                                                {
                                                                    "not": {
                                                                        "equals": [
                                                                            "@variables('vVendorName')",
                                                                            ""
                                                                        ]
                                                                    }
                                                                },
                                                                {
                                                                    "not": {
                                                                        "equals": [
                                                                            "@variables('vCompanyName')",
                                                                            ""
                                                                        ]
                                                                    }
                                                                }
                                                            ]
                                                        },
                                                        "type": "If"
                                                    }
                                                }
                                            },
                                            "expression": {
                                                "and": [
                                                    {
                                                        "greaterOrEquals": [
                                                            "@variables('vConfidenceMin')",
                                                            "@float(0.70)"
                                                        ]
                                                    },
                                                    {
                                                        "not": {
                                                            "equals": [
                                                                "@variables('vVendorName')",
                                                                ""
                                                            ]
                                                        }
                                                    },
                                                    {
                                                        "not": {
                                                            "equals": [
                                                                "@variables('vCompanyName')",
                                                                ""
                                                            ]
                                                        }
                                                    },
                                                    {
                                                        "not": {
                                                            "equals": [
                                                                "@variables('vInvoiceTotal')",
                                                                ""
                                                            ]
                                                        }
                                                    },
                                                    {
                                                        "not": {
                                                            "equals": [
                                                                "@variables('vInvoiceNumber')",
                                                                ""
                                                            ]
                                                        }
                                                    },
                                                    {
                                                        "not": {
                                                            "equals": [
                                                                "@variables('vInvoiceDate')",
                                                                ""
                                                            ]
                                                        }
                                                    }
                                                ]
                                            },
                                            "type": "If",
                                            "description": "Ensuring the lowest confidence score is over 80% and the vital fields are populated"
                                        },
                                        "Update_a_row": {
                                            "runAfter": {
                                                "Setting_the_Status": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "ApiConnection",
                                            "inputs": {
                                                "host": {
                                                    "connection": {
                                                        "name": "@parameters('$connections')['commondataservice']['connectionId']"
                                                    }
                                                },
                                                "method": "patch",
                                                "body": {
                                                    "eire_companyname": "@variables('vCompanyName')",
                                                    "eire_customernamescore": "@variables('vCompanyNameConfidence')",
                                                    "eire_invoicedate": "@variables('vConvertedInvoiceDate')",
                                                    "eire_invoicedatescore": "@variables('vInvoiceDateConfidence')",
                                                    "eire_invoiceimagename": "@body('Create_file')?['Name']",
                                                    "eire_invoicenumber": "@variables('vInvoiceNumber')",
                                                    "eire_invoicenumberscore": "@variables('vInvoiceNumberConfidence')",
                                                    "eire_ponumber": "@variables('vPONumber')",
                                                    "eire_ponumberscore": "@variables('vPONumberConfidence')",
                                                    "statuscode": "@variables('vStatusName')",
                                                    "eire_totalamount": "@variables('FloatInvoiceTotal')",
                                                    "eire_totalamountscore": "@variables('vInvoiceTotalConfidence')",
                                                    "eire_vatamount": "@variables('FloatInvoiceVATAmount')",
                                                    "eire_vatamountscore": "@variables('vInvoiceVATAmountConfidence')",
                                                    "eire_vendervatnumber": "@variables('vVendorVATReg')",
                                                    "eire_vendorname": "@variables('vVendorName')",
                                                    "eire_vendornamescore": "@variables('vVendorNameConfidence')",
                                                    "eire_vendorvatnumberscore": "@variables('vVendorVATRegConfidence')"
                                                },
                                                "headers": {
                                                    "prefer": "return=representation,odata.include-annotations=*",
                                                    "accept": "application/json;odata.metadata=full",
                                                    "organization": "@parameters('Dataverse URL')"
                                                },
                                                "path": "/api/data/v9.1/@{encodeURIComponent(encodeURIComponent('eire_invoices'))}(@{encodeURIComponent(encodeURIComponent(body('Create_new_Invoice_Record')?['eire_invoiceid']))})"
                                            }
                                        },
                                        "Set_Adaptive_Card_-_Failed_to_update_Invoice": {
                                            "runAfter": {
                                                "Update_a_row": [
                                                    "Failed"
                                                ]
                                            },
                                            "type": "SetVariable",
                                            "inputs": {
                                                "name": "Adaptive Card",
                                                "value": {
                                                    "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                                                    "type": "AdaptiveCard",
                                                    "version": "1.6",
                                                    "body": [
                                                        {
                                                            "type": "ColumnSet",
                                                            "columns": [
                                                                {
                                                                    "type": "Column",
                                                                    "width": "stretch",
                                                                    "items": [
                                                                        {
                                                                            "type": "TextBlock",
                                                                            "text": "Invoice # @{body('Convert_PDF_to_JPG')?['Filename']}",
                                                                            "wrap": true,
                                                                            "size": "large",
                                                                            "weight": "bolder"
                                                                        }
                                                                    ]
                                                                },
                                                                {
                                                                    "type": "Column",
                                                                    "width": "stretch",
                                                                    "items": [
                                                                        {
                                                                            "type": "TextBlock",
                                                                            "text": "Status Rejected",
                                                                            "wrap": true,
                                                                            "color": "warning",
                                                                            "weight": "bolder",
                                                                            "horizontalAlignment": "right"
                                                                        },
                                                                        {
                                                                            "type": "Image",
                                                                            "horizontalAlignment": "Right",
                                                                            "id": "invoiceImage",
                                                                            "url": "https://evrosdemo.sharepoint.com/teams/AliceDev@{body('Create_file')?['Path']}",
                                                                            "width": "66px",
                                                                            "height": "88px",
                                                                            "selectAction": {
                                                                                "type": "Action.OpenUrl",
                                                                                "url": "https://evrosdemo.sharepoint.com/teams/AliceDev@{body('Create_file')?['Path']}"
                                                                            }
                                                                        }
                                                                    ]
                                                                }
                                                            ]
                                                        },
                                                        {
                                                            "type": "TextBlock",
                                                            "text": "An issue was encountered while updating the invoice record from@{variables('vVendorName')}. Would you like to assist with resolving this?",
                                                            "wrap": true
                                                        },
                                                        {
                                                            "type": "Input.Text",
                                                            "id": "Invoice_Id",
                                                            "isVisible": false,
                                                            "value": "@{body('Create_new_Invoice_Record')?['eire_invoiceid']}"
                                                        },
                                                        {
                                                            "type": "Input.Text",
                                                            "id": "Invoice_Image",
                                                            "isVisible": false,
                                                            "value": "https://evrosdemo.sharepoint.com/teams/AliceDev@{body('Create_file')?['Path']}"
                                                        }
                                                    ],
                                                    "actions": [
                                                        {
                                                            "type": "Action.Submit",
                                                            "title": "Yes",
                                                            "data": {
                                                                "source": "adaptiveCard",
                                                                "actionType": "userChoiceSubmit",
                                                                "choice": "yes"
                                                            }
                                                        },
                                                        {
                                                            "type": "Action.Submit",
                                                            "title": "No",
                                                            "data": {
                                                                "source": "adaptiveCard",
                                                                "actionType": "userChoiceSubmit",
                                                                "choice": "no"
                                                            }
                                                        },
                                                        {
                                                            "type": "Action.Submit",
                                                            "title": "Ask me again tomorrow",
                                                            "data": {
                                                                "source": "adaptiveCard",
                                                                "actionType": "userChoiceSubmit",
                                                                "choice": "askTomorrow"
                                                            }
                                                        },
                                                        {
                                                            "type": "Action.Submit",
                                                            "title": "Ask me again in 3 business days",
                                                            "data": {
                                                                "source": "adaptiveCard",
                                                                "actionType": "userChoiceSubmit",
                                                                "choice": "ask3Days"
                                                            }
                                                        }
                                                    ]
                                                }
                                            }
                                        },
                                        "Send_Automate_Zap": {
                                            "actions": {
                                                "Send_Zaps": {
                                                    "type": "ApiConnection",
                                                    "inputs": {
                                                        "host": {
                                                            "connection": {
                                                                "name": "@parameters('$connections')['lnbits']['connectionId']"
                                                            }
                                                        },
                                                        "method": "post",
                                                        "body": {
                                                            "senderWalletId": "@parameters('LnBits Funding User ID')",
                                                            "receiverWalletId": "@parameters('Alice LNBits UserID')",
                                                            "zapAmount": 50,
                                                            "tag": "zap"
                                                        },
                                                        "path": "/sendZaps",
                                                        "queries": {
                                                            "siteURL": "@parameters('LNBitsURL')",
                                                            "adminkey": "@parameters('LNBits Admin Key')"
                                                        }
                                                    }
                                                }
                                            },
                                            "runAfter": {
                                                "For_each": [
                                                    "Succeeded",
                                                    "Failed",
                                                    "Skipped"
                                                ]
                                            },
                                            "type": "Scope"
                                        }
                                    },
                                    "runAfter": {
                                        "Create_Jpeg_invoice": [
                                            "Succeeded"
                                        ]
                                    },
                                    "else": {
                                        "actions": {
                                            "Move_to_Failed_Processed_Invoice": {
                                                "metadata": {
                                                    "Id::AAMkAGIyNDlkZGI5LTBmMjctNDYwMi05NjcwLWIxYmVjZTllODliOQAuAAAAAABORfst7MeLT4n9yVnwSQO0AQCOj5-6RTM5TJmUex6dIr2-AAADyc6HAAA=": "Failed Invoices"
                                                },
                                                "type": "ApiConnection",
                                                "inputs": {
                                                    "host": {
                                                        "connection": {
                                                            "name": "@parameters('$connections')['office365']['connectionId']"
                                                        }
                                                    },
                                                    "method": "post",
                                                    "path": "/v2/Mail/Move/@{encodeURIComponent(triggerBody()?['id'])}",
                                                    "queries": {
                                                        "mailboxAddress": "accounts@evolabs.ie",
                                                        "folderPath": "Id::AAMkAGIyNDlkZGI5LTBmMjctNDYwMi05NjcwLWIxYmVjZTllODliOQAuAAAAAABORfst7MeLT4n9yVnwSQO0AQCOj5-6RTM5TJmUex6dIr2-AAADyc6HAAA="
                                                    }
                                                }
                                            },
                                            "Send_AdaptiveCard_Not_an_Invoice_-_No": {
                                                "runAfter": {
                                                    "Set_Adaptive_Card_-_Failed_to_Recognize_as_an_invoice": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "SendAdaptiveCard",
                                                    "value": "Yes"
                                                }
                                            },
                                            "Set_Adaptive_Card_-_Failed_to_Recognize_as_an_invoice": {
                                                "runAfter": {
                                                    "Move_to_Failed_Processed_Invoice": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "Adaptive Card",
                                                    "value": {
                                                        "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                                                        "type": "AdaptiveCard",
                                                        "version": "1.6",
                                                        "body": [
                                                            {
                                                                "type": "ColumnSet",
                                                                "columns": [
                                                                    {
                                                                        "type": "Column",
                                                                        "width": "stretch",
                                                                        "items": [
                                                                            {
                                                                                "type": "TextBlock",
                                                                                "text": "Invoice # @{body('Convert_PDF_to_JPG')?['Filename']}",
                                                                                "wrap": true,
                                                                                "size": "large",
                                                                                "weight": "bolder"
                                                                            }
                                                                        ]
                                                                    },
                                                                    {
                                                                        "type": "Column",
                                                                        "width": "stretch",
                                                                        "items": [
                                                                            {
                                                                                "type": "TextBlock",
                                                                                "text": "Status: Failed",
                                                                                "wrap": true,
                                                                                "color": "warning",
                                                                                "weight": "bolder",
                                                                                "horizontalAlignment": "right"
                                                                            },
                                                                            {
                                                                                "type": "Image",
                                                                                "horizontalAlignment": "Right",
                                                                                "id": "invoiceImage",
                                                                                "url": "https://evrosdemo.sharepoint.com/teams/AliceDev@{body('Create_file')?['Path']}",
                                                                                "width": "66px",
                                                                                "height": "88px",
                                                                                "selectAction": {
                                                                                    "type": "Action.OpenUrl",
                                                                                    "url": "https://evrosdemo.sharepoint.com/teams/AliceDev@{body('Create_file')?['Path']}"
                                                                                }
                                                                            }
                                                                        ]
                                                                    }
                                                                ]
                                                            },
                                                            {
                                                                "type": "TextBlock",
                                                                "text": "We were able to determine if @{body('Convert_PDF_to_JPG')?['Filename']} was an invoice. Would you like to assist with resolving this?",
                                                                "wrap": true
                                                            },
                                                            {
                                                                "type": "Input.Text",
                                                                "id": "InvoiceId",
                                                                "isVisible": false,
                                                                "value": "@{body('Create_new_Invoice_Record')?['eire_invoiceid']}"
                                                            },
                                                            {
                                                                "type": "Input.Text",
                                                                "id": "Invoice_Image",
                                                                "isVisible": false,
                                                                "value": "https://evrosdemo.sharepoint.com/teams/AliceDev@{body('Create_file')?['Path']}"
                                                            }
                                                        ],
                                                        "actions": [
                                                            {
                                                                "type": "Action.Submit",
                                                                "title": "Yes",
                                                                "data": {
                                                                    "source": "adaptiveCard",
                                                                    "actionType": "userChoiceSubmit",
                                                                    "choice": "yes"
                                                                }
                                                            },
                                                            {
                                                                "type": "Action.Submit",
                                                                "title": "No",
                                                                "data": {
                                                                    "source": "adaptiveCard",
                                                                    "actionType": "userChoiceSubmit",
                                                                    "choice": "no"
                                                                }
                                                            },
                                                            {
                                                                "type": "Action.Submit",
                                                                "title": "Ask me again tomorrow",
                                                                "data": {
                                                                    "source": "adaptiveCard",
                                                                    "actionType": "userChoiceSubmit",
                                                                    "choice": "askTomorrow"
                                                                }
                                                            },
                                                            {
                                                                "type": "Action.Submit",
                                                                "title": "Ask me again in 3 business days",
                                                                "data": {
                                                                    "source": "adaptiveCard",
                                                                    "actionType": "userChoiceSubmit",
                                                                    "choice": "ask3Days"
                                                                }
                                                            }
                                                        ]
                                                    }
                                                }
                                            }
                                        }
                                    },
                                    "expression": {
                                        "and": [
                                            {
                                                "equals": [
                                                    "@variables('NextStep')",
                                                    "@true"
                                                ]
                                            },
                                            {
                                                "contains": [
                                                    "@toUpper(variables('vDocumentType'))",
                                                    "INVOICE"
                                                ]
                                            }
                                        ]
                                    },
                                    "type": "If"
                                },
                                "Create_Jpeg_invoice": {
                                    "actions": {
                                        "Convert_PDF_to_JPG": {
                                            "type": "ApiConnection",
                                            "inputs": {
                                                "host": {
                                                    "connection": {
                                                        "name": "@parameters('$connections')['encodiandocumentmanager']['connectionId']"
                                                    }
                                                },
                                                "method": "post",
                                                "body": {
                                                    "fileContent": "@item()?['contentBytes']",
                                                    "outputFilename": "@item()?['name']",
                                                    "imageQuality": 80,
                                                    "resolution": 96,
                                                    "resolutionUnit": "None",
                                                    "compressionColourMode": "RGB",
                                                    "compressionType": "Baseline",
                                                    "enhancedCompression": false
                                                },
                                                "path": "/api/v1/Core/ConvertPdfToJpg"
                                            }
                                        },
                                        "Create_file": {
                                            "runAfter": {
                                                "Convert_PDF_to_JPG": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "ApiConnection",
                                            "inputs": {
                                                "host": {
                                                    "connection": {
                                                        "name": "@parameters('$connections')['sharepointonline']['connectionId']"
                                                    }
                                                },
                                                "method": "post",
                                                "body": "@base64ToBinary(body('Convert_PDF_to_JPG')?['FileContent'])",
                                                "path": "/datasets/@{encodeURIComponent(encodeURIComponent('https://evrosdemo.sharepoint.com/teams/AliceDev'))}/files",
                                                "queries": {
                                                    "folderPath": "/Shared Documents",
                                                    "name": "@body('Convert_PDF_to_JPG')?['Filename']",
                                                    "queryParametersSingleEncoded": true
                                                }
                                            },
                                            "runtimeConfiguration": {
                                                "contentTransfer": {
                                                    "transferMode": "Chunked"
                                                }
                                            }
                                        }
                                    },
                                    "runAfter": {
                                        "Is_this_a_PDF_Invoice": [
                                            "Succeeded"
                                        ]
                                    },
                                    "type": "Scope"
                                }
                            },
                            "runAfter": {
                                "SendAdaptiveCard": [
                                    "Succeeded"
                                ]
                            },
                            "type": "Foreach",
                            "runtimeConfiguration": {
                                "concurrency": {
                                    "repetitions": 1
                                }
                            }
                        },
                        "Initialize_variable_1": {
                            "runAfter": {
                                "StatusColour": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "StatusActualName",
                                        "type": "string"
                                    }
                                ]
                            }
                        },
                        "Invalid_Characters_Array": {
                            "runAfter": {
                                "Currency_Symbols_Array": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "InvalidCharactersArray",
                                        "type": "array",
                                        "value": [
                                            "\\",
                                            "/",
                                            ":",
                                            "*",
                                            "?",
                                            "\"",
                                            "<",
                                            ">",
                                            "|",
                                            "#",
                                            "%",
                                            "&",
                                            "{",
                                            "}",
                                            "$",
                                            "!",
                                            "'",
                                            "+",
                                            "`",
                                            "~",
                                            "^",
                                            "@",
                                            "="
                                        ]
                                    }
                                ]
                            }
                        },
                        "Invoice_Date": {
                            "runAfter": {
                                "Invoice_Number_Confidence": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "vInvoiceDate",
                                        "type": "string"
                                    }
                                ]
                            }
                        },
                        "Invoice_Date_Confidence": {
                            "runAfter": {
                                "Invoice_Date": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "vInvoiceDateConfidence",
                                        "type": "float"
                                    }
                                ]
                            }
                        },
                        "Invoice_Number": {
                            "runAfter": {
                                "Company_Address_Confidence": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "vInvoiceNumber",
                                        "type": "string"
                                    }
                                ]
                            }
                        },
                        "Invoice_Number_Confidence": {
                            "runAfter": {
                                "Invoice_Number": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "vInvoiceNumberConfidence",
                                        "type": "float"
                                    }
                                ]
                            }
                        },
                        "Invoice_SubTotal": {
                            "runAfter": {
                                "Invoice_Total_Confidence": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "vInvoiceSubTotal",
                                        "type": "string"
                                    }
                                ]
                            }
                        },
                        "Invoice_SubTotal_Confidence": {
                            "runAfter": {
                                "FloatInvoiceSubTotal": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "vInvoiceSubTotalConfidence",
                                        "type": "float"
                                    }
                                ]
                            }
                        },
                        "Invoice_Total": {
                            "runAfter": {
                                "FloatInvoiceTotal": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "vInvoiceTotal",
                                        "type": "string"
                                    }
                                ]
                            }
                        },
                        "Invoice_Total_Confidence": {
                            "runAfter": {
                                "Invoice_Total": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "vInvoiceTotalConfidence",
                                        "type": "float"
                                    }
                                ]
                            }
                        },
                        "Invoice_VAT_Amount": {
                            "runAfter": {
                                "Invoice_SubTotal_Confidence": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "vInvoiceVATAmount",
                                        "type": "string"
                                    }
                                ]
                            }
                        },
                        "Invoice_VAT_Amount_Confidence": {
                            "runAfter": {
                                "PO_Number_Confidence": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "vInvoiceVATAmountConfidence",
                                        "type": "float"
                                    }
                                ]
                            }
                        },
                        "NextStep": {
                            "runAfter": {
                                "Status_Name": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "NextStep",
                                        "type": "boolean",
                                        "value": false
                                    }
                                ]
                            }
                        },
                        "Number_of_Processed_Invoices": {
                            "runAfter": {
                                "TotalAttachments": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "vTotalProcessedInvoices",
                                        "type": "integer",
                                        "value": 0
                                    }
                                ]
                            }
                        },
                        "PO_Number": {
                            "runAfter": {
                                "FloatInvoiceVATAmount": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "vPONumber",
                                        "type": "string"
                                    }
                                ]
                            }
                        },
                        "PO_Number_Confidence": {
                            "runAfter": {
                                "PO_Number": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "vPONumberConfidence",
                                        "type": "float"
                                    }
                                ]
                            }
                        },
                        "Send_Teams_Notification": {
                            "actions": {
                                "Is_Adaptive_card_needed": {
                                    "actions": {
                                        "Create_Adative_Card_4": {
                                            "type": "Compose",
                                            "inputs": {
                                                "adaptiveCard": "@variables('Adaptive Card')",
                                                "channelId": "@{parameters('MS Teams Channel ID')}"
                                            }
                                        },
                                        "Send_message_in_Teams_Channel_4": {
                                            "runAfter": {
                                                "Create_Adative_Card_4": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Http",
                                            "inputs": {
                                                "uri": "@parameters('Function URL')",
                                                "method": "POST",
                                                "body": "@outputs('Create_Adative_Card_4')"
                                            },
                                            "runtimeConfiguration": {
                                                "contentTransfer": {
                                                    "transferMode": "Chunked"
                                                }
                                            }
                                        }
                                    },
                                    "else": {
                                        "actions": {
                                            "No_need_for_Adaptive_Card": {
                                                "type": "Compose",
                                                "inputs": "No Need to send Adaptive Card"
                                            }
                                        }
                                    },
                                    "expression": {
                                        "and": [
                                            {
                                                "equals": [
                                                    "@variables('SendAdaptiveCard')",
                                                    "Yes"
                                                ]
                                            }
                                        ]
                                    },
                                    "type": "If"
                                }
                            },
                            "runAfter": {
                                "For_Each_Attachment": [
                                    "Succeeded",
                                    "Failed"
                                ]
                            },
                            "type": "Scope"
                        },
                        "StatusColour": {
                            "runAfter": {
                                "Compose_1": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "StatusColor",
                                        "type": "string"
                                    }
                                ]
                            }
                        },
                        "Status_Name": {
                            "runAfter": {
                                "Invalid_Characters_Array": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "vStatusName",
                                        "type": "integer"
                                    }
                                ]
                            },
                            "description": "1 - Active\n683430001 - New\n683430002 - Processed\n683430003 - Rejected\n683430004 - Failed"
                        },
                        "Switch": {
                            "runAfter": {
                                "Send_Teams_Notification": [
                                    "Succeeded",
                                    "Failed",
                                    "Skipped"
                                ]
                            },
                            "cases": {
                                "Failed_Invoices": {
                                    "case": 683430004,
                                    "actions": {
                                        "Move_to_Failed_Folder": {
                                            "metadata": {
                                                "Id::AAMkAGIyNDlkZGI5LTBmMjctNDYwMi05NjcwLWIxYmVjZTllODliOQAuAAAAAABORfst7MeLT4n9yVnwSQO0AQCOj5-6RTM5TJmUex6dIr2-AAADyc6HAAA=": "Failed Invoices"
                                            },
                                            "type": "ApiConnection",
                                            "inputs": {
                                                "host": {
                                                    "connection": {
                                                        "name": "@parameters('$connections')['office365']['connectionId']"
                                                    }
                                                },
                                                "method": "post",
                                                "path": "/v2/Mail/Move/@{encodeURIComponent(triggerBody()?['id'])}",
                                                "queries": {
                                                    "mailboxAddress": "accounts@evolabs.ie",
                                                    "folderPath": "Id::AAMkAGIyNDlkZGI5LTBmMjctNDYwMi05NjcwLWIxYmVjZTllODliOQAuAAAAAABORfst7MeLT4n9yVnwSQO0AQCOj5-6RTM5TJmUex6dIr2-AAADyc6HAAA="
                                                }
                                            }
                                        }
                                    }
                                },
                                "Processed_Invoices": {
                                    "case": 683430002,
                                    "actions": {
                                        "Move_to_Processed_Folder": {
                                            "metadata": {
                                                "Id::AAMkAGIyNDlkZGI5LTBmMjctNDYwMi05NjcwLWIxYmVjZTllODliOQAuAAAAAABORfst7MeLT4n9yVnwSQO0AQCOj5-6RTM5TJmUex6dIr2-AAADyc6GAAA=": "Processed Invoices"
                                            },
                                            "type": "ApiConnection",
                                            "inputs": {
                                                "host": {
                                                    "connection": {
                                                        "name": "@parameters('$connections')['office365']['connectionId']"
                                                    }
                                                },
                                                "method": "post",
                                                "path": "/v2/Mail/Move/@{encodeURIComponent(triggerBody()?['id'])}",
                                                "queries": {
                                                    "mailboxAddress": "accounts@evolabs.ie",
                                                    "folderPath": "Id::AAMkAGIyNDlkZGI5LTBmMjctNDYwMi05NjcwLWIxYmVjZTllODliOQAuAAAAAABORfst7MeLT4n9yVnwSQO0AQCOj5-6RTM5TJmUex6dIr2-AAADyc6GAAA="
                                                }
                                            }
                                        }
                                    }
                                },
                                "Rejected_Invoices": {
                                    "case": 683430003,
                                    "actions": {
                                        "Move_to_Rejected_Folder": {
                                            "metadata": {
                                                "Id::AAMkAGIyNDlkZGI5LTBmMjctNDYwMi05NjcwLWIxYmVjZTllODliOQAuAAAAAABORfst7MeLT4n9yVnwSQO0AQCOj5-6RTM5TJmUex6dIr2-AAADyc6HAAA=": "Failed Invoices",
                                                "Id::AAMkAGIyNDlkZGI5LTBmMjctNDYwMi05NjcwLWIxYmVjZTllODliOQAuAAAAAABORfst7MeLT4n9yVnwSQO0AQCOj5-6RTM5TJmUex6dIr2-AAADyc6IAAA=": "Rejected Invoices",
                                                "Id::AQMkAGIyNDlkZABiOS0wZjI3LTQ2MDItOTY3MC1iMWJlY2U5ZTg5YjkALgAAA05F_y3sx4tPif3JWfBJA7QBAI6Pn-pFMzlMmZR7Hp0ivb8AAAKAmAAAAA==": "Archive"
                                            },
                                            "type": "ApiConnection",
                                            "inputs": {
                                                "host": {
                                                    "connection": {
                                                        "name": "@parameters('$connections')['office365']['connectionId']"
                                                    }
                                                },
                                                "method": "post",
                                                "path": "/v2/Mail/Move/@{encodeURIComponent(triggerBody()?['id'])}",
                                                "queries": {
                                                    "mailboxAddress": "accounts@evolabs.ie",
                                                    "folderPath": "Id::AAMkAGIyNDlkZGI5LTBmMjctNDYwMi05NjcwLWIxYmVjZTllODliOQAuAAAAAABORfst7MeLT4n9yVnwSQO0AQCOj5-6RTM5TJmUex6dIr2-AAADyc6IAAA="
                                                }
                                            }
                                        }
                                    }
                                }
                            },
                            "default": {
                                "actions": {
                                    "Move_email_(V2)": {
                                        "metadata": {
                                            "Id::AAMkAGIyNDlkZGI5LTBmMjctNDYwMi05NjcwLWIxYmVjZTllODliOQAuAAAAAABORfst7MeLT4n9yVnwSQO0AQCOj5-6RTM5TJmUex6dIr2-AAADyc6HAAA=": "Failed Invoices"
                                        },
                                        "type": "ApiConnection",
                                        "inputs": {
                                            "host": {
                                                "connection": {
                                                    "name": "@parameters('$connections')['office365']['connectionId']"
                                                }
                                            },
                                            "method": "post",
                                            "path": "/v2/Mail/Move/@{encodeURIComponent(triggerBody()?['id'])}",
                                            "queries": {
                                                "mailboxAddress": "accounts@evolabs.ie",
                                                "folderPath": "Id::AAMkAGIyNDlkZGI5LTBmMjctNDYwMi05NjcwLWIxYmVjZTllODliOQAuAAAAAABORfst7MeLT4n9yVnwSQO0AQCOj5-6RTM5TJmUex6dIr2-AAADyc6HAAA="
                                            }
                                        }
                                    }
                                }
                            },
                            "expression": "@variables('vStatusName')",
                            "type": "Switch"
                        },
                        "TotalAttachments": {
                            "runAfter": {
                                "Initialize_variable_1": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "TotalAttachments",
                                        "type": "integer",
                                        "value": "@length(triggerBody()?['attachments'])"
                                    }
                                ]
                            }
                        },
                        "Total_Discount": {
                            "runAfter": {
                                "Vendor_VAT_Reg_Confidence": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "vTotalDiscount",
                                        "type": "string"
                                    }
                                ]
                            }
                        },
                        "Total_Discount_Confidence": {
                            "runAfter": {
                                "Total_Discount": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "vTotalDiscountConfidence",
                                        "type": "float"
                                    }
                                ]
                            }
                        },
                        "Total_Shipping": {
                            "runAfter": {
                                "Total_Discount_Confidence": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "TotalShipping",
                                        "type": "string"
                                    }
                                ]
                            }
                        },
                        "Total_Shipping_Confidence": {
                            "runAfter": {
                                "Total_Shipping": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "vTotalShippingConfidence",
                                        "type": "float"
                                    }
                                ]
                            }
                        },
                        "VendorAddressConfidence": {
                            "runAfter": {
                                "Vendor_Address": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "vVendor Address Confidence",
                                        "type": "float"
                                    }
                                ]
                            }
                        },
                        "Vendor_Address": {
                            "runAfter": {
                                "Vendor_Name_Confidence": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "vVendorAddress",
                                        "type": "string"
                                    }
                                ]
                            }
                        },
                        "Vendor_Name": {
                            "runAfter": {
                                "Invoice_VAT_Amount_Confidence": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "vVendorName",
                                        "type": "string"
                                    }
                                ]
                            }
                        },
                        "Vendor_Name_Confidence": {
                            "runAfter": {
                                "Vendor_Name": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "vVendorNameConfidence",
                                        "type": "float"
                                    }
                                ]
                            }
                        },
                        "Vendor_VAT_Reg": {
                            "runAfter": {
                                "VendorAddressConfidence": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "vVendorVATReg",
                                        "type": "string"
                                    }
                                ]
                            }
                        },
                        "Vendor_VAT_Reg_Confidence": {
                            "runAfter": {
                                "Vendor_VAT_Reg": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "vVendorVATRegConfidence",
                                        "type": "float"
                                    }
                                ]
                            }
                        },
                        "SendAdaptiveCard": {
                            "runAfter": {
                                "Document_Type_Confidence": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "SendAdaptiveCard",
                                        "type": "string",
                                        "value": "Yes"
                                    }
                                ]
                            }
                        }
                    },
                    "outputs": {}
                },
                "parameters": {
                    "LNBits Admin Key": {},
                    "$connections": {
                        "value": {
                            "office365": {
                                "id": "/subscriptions/7620f9be-bf91-4297-ada2-659d2695b3a1/providers/Microsoft.Web/locations/northeurope/managedApis/office365",
                                "connectionId": "[parameters('connections_office365_externalid')]",
                                "connectionName": "office365"
                            },
                            "powerpulse": {
                                "id": "[parameters('customApis_powerpulse_externalid')]",
                                "connectionId": "[parameters('connections_powerpulse_externalid')]",
                                "connectionName": "powerpulse"
                            },
                            "commondataservice": {
                                "id": "/subscriptions/7620f9be-bf91-4297-ada2-659d2695b3a1/providers/Microsoft.Web/locations/northeurope/managedApis/commondataservice",
                                "connectionId": "[parameters('connections_commondataservice_externalid')]",
                                "connectionName": "commondataservice"
                            },
                            "formrecognizer": {
                                "id": "/subscriptions/7620f9be-bf91-4297-ada2-659d2695b3a1/providers/Microsoft.Web/locations/northeurope/managedApis/formrecognizer",
                                "connectionId": "[parameters('connections_formrecognizer_externalid')]",
                                "connectionName": "formrecognizer"
                            },
                            "encodiandocumentmanager": {
                                "id": "/subscriptions/7620f9be-bf91-4297-ada2-659d2695b3a1/providers/Microsoft.Web/locations/northeurope/managedApis/encodiandocumentmanager",
                                "connectionId": "[parameters('connections_encodiandocumentmanager_externalid')]",
                                "connectionName": "encodiandocumentmanager"
                            },
                            "sharepointonline": {
                                "id": "/subscriptions/7620f9be-bf91-4297-ada2-659d2695b3a1/providers/Microsoft.Web/locations/northeurope/managedApis/sharepointonline",
                                "connectionId": "[parameters('connections_sharepointonline_externalid')]",
                                "connectionName": "sharepointonline"
                            },
                            "lnbits": {
                                "id": "[parameters('customApis_lnbits_externalid')]",
                                "connectionId": "[parameters('connections_lnbits_externalid')]",
                                "connectionName": "lnbits"
                            }
                        }
                    }
                }
            }
        }
    ]
}